<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="The world’s most widely used web app scanner. Free and open source. ZAP is a community project actively maintained by a dedicated international team, and a GitHub Top 1000 project.">
  
    
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://www.zaproxy.org/blog/2023-09-08-ds-store-parsing/images/zapbot-ds-store.png">
  <meta name="twitter:title" content="Parsing .DS_Store files with ZAP">
  <meta name="twitter:description" content="ZAP Spider can now probe and parse macOS’ .DS_Store files.">

    <meta property="og:url" content="/blog/2023-09-08-ds-store-parsing/">
  <meta property="og:site_name" content="ZAP">
  <meta property="og:title" content="Parsing .DS_Store files with ZAP">
  <meta property="og:description" content="ZAP Spider can now probe and parse macOS’ .DS_Store files.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2023-09-08T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-09-08T00:00:00+00:00">
    <meta property="article:tag" content="Blog">
    <meta property="article:tag" content="Recon">
    <meta property="article:tag" content="Spider">
    <meta property="og:image" content="https://www.zaproxy.org/blog/2023-09-08-ds-store-parsing/images/zapbot-ds-store.png">

  
  <title>ZAP &ndash; Parsing .DS_Store files with ZAP</title>

  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css?family=Quicksand:500,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Istok+Web|Open+Sans:400,700|Rubik&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.6/lunr.min.js"></script>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JDLGW1172L"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-JDLGW1172L');
  </script>
  
  
  
    <link href="/main.cb156c.css" rel="stylesheet">
  
</head>
<body>
<div id="page-container">
 <div id="content-wrap">
  <header class="site-header">
    <div class="wrapper flex jc-sb ai-c">
    <div class="flex">
        <nav class="site-nav" role="navigation">
        <a href="/" aria-label="return to landing page" class="logo">
            <img src = "/img/zap-by-checkmarx.svg" height="65px" alt="ZAP By Checkmarx"/>
        </a>
        </nav>
    </div>
    <div class="nav-content flex">
      <nav class="site-nav" role="navigation">
        <div class="hamburger-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </div>
        <input class="hamburger-click" aria-label="site menu" type="checkbox" />
        <ul id="primary-menu" class="flex">
          
          
            
              <li class="">
                  <a href="/blog/" title="Blog page">
                  Blog
                </a>
              </li>
            
          
            
              <li class="">
                  <a href="/videos/" title="Videos page">
                  Videos
                </a>
              </li>
            
          
            
              <li class="">
                  <a href="/docs/" title="Documentation page">
                  Documentation
                </a>
              </li>
            
          
            
              <li class="">
                  <a href="/community/" title="Community page">
                  Community
                </a>
              </li>
            
          
          <li id="search-menu">
            <a class="toggler" href="#">
              <img height="20" width="20" src="/img/search.svg" alt="Search icon"/>
            </a>
  
            <form data-no-csrf action="/search">
              <input type="text" name="q" placeholder="Search ..." style="width: 100%" />
            </form>
          </li>
        </ul>
      </nav>
      <div class="download-button">
        <a id="cta-download" href="/download/" class="button button--orange">Download</a>
      </div>
      <div class="social-links header-social">
        <ul class="flex ai-c no-list-style m-10 px-20">
          <li>
            <a href="https://github.com/zaproxy" aria-label="Go to ZAP's GitHub repo"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.36 18.88"><path d="M9.68 0a9.68 9.68 0 0 0-3.06 18.86c.48.09.64-.21.64-.46v-1.8C4.57 17.18 4 15.45 4 15.45A2.57 2.57 0 0 0 2.93 14c-.88-.6.07-.59.07-.59a2 2 0 0 1 1.48 1 2.06 2.06 0 0 0 2.82.8A2 2 0 0 1 7.91 14c-2.15-.29-4.41-1.12-4.41-4.83a3.72 3.72 0 0 1 1-2.59A3.53 3.53 0 0 1 4.59 4s.82-.26 2.67 1a9 9 0 0 1 4.84 0c1.9-1.25 2.66-1 2.66-1a3.49 3.49 0 0 1 .1 2.57 3.71 3.71 0 0 1 1 2.59c0 3.72-2.26 4.54-4.42 4.78a2.3 2.3 0 0 1 .67 1.79v2.67c0 .25.15.56.64.46A9.68 9.68 0 0 0 9.68 0z" fill="#00549e"/></svg></a>
          </li>
          <li>
              <a href="https://twitter.com/zaproxy" aria-label="Follow ZAP on Twitter"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.36 15.73"><path d="M19.36 1.86a8 8 0 0 1-2.28.63 3.94 3.94 0 0 0 1.74-2.2 7.53 7.53 0 0 1-2.52 1 4 4 0 0 0-6.77 3.59A11.29 11.29 0 0 1 1.35.73 4 4 0 0 0 2.58 6a3.91 3.91 0 0 1-1.8-.5A4 4 0 0 0 4 9.48a4 4 0 0 1-1.79.06 4 4 0 0 0 3.67 2.76A8 8 0 0 1 0 14a11.32 11.32 0 0 0 6.09 1.78A11.24 11.24 0 0 0 17.38 3.92a8.08 8.08 0 0 0 1.98-2.06z" fill="#00549e"/></svg></a>
          </li>
        </ul>
      </div>
    </div>

  </div>
</header>

  

<section class="bolt-header">
  <div class="wrapper py-20">
    <h1 class="text--white">Parsing .DS_Store files with ZAP</h1>
  </div>
</section>

<div class="wrapper py-70" data-kind="page">
    <div class="flex latest-versions">
      <article class="col-2-3 pr-30 content single-post">
          <div class="breadcrumbs">
              <a href="/blog/">The ZAP Blog</a>
          </div>

          <main class="post-content">
            <section class="p-10 bg--blue-lightest mb-10 mt-10 smaller-text text--blue-dark">
              Posted <span class="post-date">Friday September 8, 2023</span>
              <span class="word-count fl-r"> 1276 Words </span>
            </section>
            <p>macOS has been using <a href="https://en.wikipedia.org/wiki/.DS_Store" title=".DS_Store"><code>.DS_Store</code></a> hidden files for many
years to store metadata about files and folders on a file system. These metadata
are mainly created and used by the <a href="https://en.m.wikipedia.org/wiki/Finder_(software)" title="Finder (software)">Finder</a> to store
attributes like your preferred view option for a particular folder, or the icon
positions of the files it contains.</p>
<p><code>.DS_Store</code> files, when accidentally published and accessible on the Internet,
can leak information about the structure of a file hierarchy, leading to
potential information disclosure vulnerabilities. It is often the case when
stored in the Git repository of a website.</p>
<p><img src="images/zapbot-ds-store.png" alt="ZAPbot stumbling upon a .DS_Store file"></p>
<p>Discovering and reading the contents of <code>.DS_Store</code> files present on a website
can prove to be a valuable asset when conducting web security audits and
penetration tests. This has led me to the idea of integrating this
reconnaissance task as part of the ZAP Spider tool, enabling the process to be
fully automated and saving time during security engagements. But first things
first, one needs to parse the internal structure of such files.</p>

<h2 id="parsing-ds_store-files">Parsing .DS_Store Files <a class="header-link" href="#parsing-ds_store-files"><svg class="fill-current o-60 hover-accent-color-light" height="22px" viewBox="0 0 24 24" width="22px" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z" fill="currentColor"/></svg></a></h2>
<p>The specifications detailing the internal structure of <code>.DS_Store</code> files have
never been made public, but <a href="https://web.archive.org/web/20230607153117/https://0day.work/parsing-the-ds_store-file-format/" title="Parsing the .DS_Store file format | Sebastian Neef - 0day.work">thanks to community-driven
efforts</a>, most parts have been reverse engineered,
enabling people to create custom parsers. Nevertheless, writing a parser for
<code>.DS_Store</code> files is not a trivial task given the complexity of the format. This
is why few implementations can be found online, and most of them are in
Python, Go, or Perl only.</p>
<p>Instead of writing a file parser from scratch, the <a href="https://kaitai.io/" title="Kaitai Struct">Kaitai Struct
project</a> allows to write a generic description of a binary file
format, and then to programmatically generate the code of a parser in a specific
programming language. In other words, Kaitai Struct allows you to describe a
file format only once and then produce parsers in many programming languages
such as Python, Java, PHP, Ruby, etc.</p>
<p>Let&rsquo;s have a look at a small example taken from the official website of the
Kaitai Struct project:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">meta</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">id</span>: <span style="color:#ae81ff">gif</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">file-extension</span>: <span style="color:#ae81ff">gif</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">endian</span>: <span style="color:#ae81ff">le</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">seq</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">header</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">header</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">logical_screen</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">logical_screen</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">types</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">header</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seq</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">magic</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">contents</span>: <span style="color:#e6db74">&#39;GIF&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">version</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">size</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">logical_screen</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seq</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">image_width</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">u2</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">image_height</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">u2</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">flags</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">u1</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">bg_color_index</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">u1</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">pixel_aspect_ratio</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">u1</span>
</span></span></code></pre></div><p>This example is a partial description of the GIF file format. The description
itself is a YAML file comprising the following main sections:</p>
<ul>
<li><code>meta</code>: Metadata of the file description such as its title, file extension if
any, license, default endianness to use when parsing, etc.</li>
<li><code>seq</code>: Sequence of attributes with their type, size when needed (e.g.
strings), documentation, etc.</li>
<li><code>types</code>: It is possible to create your own types and to instantiate them like
done for <code>header</code> and <code>logical_screen</code>. As you can see, each type has its own
sequence of attributes.</li>
</ul>
<p>When compiled with version 0.10 of the Kaitai Struct compiler with Python as
target, the following code is produced:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># This is a generated file! Please edit source .ksy file and use kaitai-struct-compiler to rebuild</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> kaitaistruct
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> kaitaistruct <span style="color:#f92672">import</span> KaitaiStruct, KaitaiStream, BytesIO
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> getattr(kaitaistruct, <span style="color:#e6db74">&#39;API_VERSION&#39;</span>, (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">9</span>)) <span style="color:#f92672">&lt;</span> (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">9</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;Incompatible Kaitai Struct Python API: 0.9 or later is required, but you have </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (kaitaistruct<span style="color:#f92672">.</span>__version__))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Gif</span>(KaitaiStruct):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, _io, _parent<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, _root<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_io <span style="color:#f92672">=</span> _io
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_parent <span style="color:#f92672">=</span> _parent
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_root <span style="color:#f92672">=</span> _root <span style="color:#66d9ef">if</span> _root <span style="color:#66d9ef">else</span> self
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_read</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>header <span style="color:#f92672">=</span> Gif<span style="color:#f92672">.</span>Header(self<span style="color:#f92672">.</span>_io, self, self<span style="color:#f92672">.</span>_root)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>logical_screen <span style="color:#f92672">=</span> Gif<span style="color:#f92672">.</span>LogicalScreen(self<span style="color:#f92672">.</span>_io, self, self<span style="color:#f92672">.</span>_root)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Header</span>(KaitaiStruct):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> __init__(self, _io, _parent<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, _root<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_io <span style="color:#f92672">=</span> _io
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_parent <span style="color:#f92672">=</span> _parent
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_root <span style="color:#f92672">=</span> _root <span style="color:#66d9ef">if</span> _root <span style="color:#66d9ef">else</span> self
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_read</span>(self):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>magic <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_io<span style="color:#f92672">.</span>read_bytes(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>magic <span style="color:#f92672">==</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x47\x49\x46</span><span style="color:#e6db74">&#34;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> kaitaistruct<span style="color:#f92672">.</span>ValidationNotEqualError(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x47\x49\x46</span><span style="color:#e6db74">&#34;</span>, self<span style="color:#f92672">.</span>magic, self<span style="color:#f92672">.</span>_io, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#34;/types/header/seq/0&#34;</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>version <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_io<span style="color:#f92672">.</span>read_bytes(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LogicalScreen</span>(KaitaiStruct):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> __init__(self, _io, _parent<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, _root<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_io <span style="color:#f92672">=</span> _io
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_parent <span style="color:#f92672">=</span> _parent
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_root <span style="color:#f92672">=</span> _root <span style="color:#66d9ef">if</span> _root <span style="color:#66d9ef">else</span> self
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_read</span>(self):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>image_width <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_io<span style="color:#f92672">.</span>read_u2le()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>image_height <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_io<span style="color:#f92672">.</span>read_u2le()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>flags <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_io<span style="color:#f92672">.</span>read_u1()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>bg_color_index <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_io<span style="color:#f92672">.</span>read_u1()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>pixel_aspect_ratio <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_io<span style="color:#f92672">.</span>read_u1()
</span></span></code></pre></div><p>Note that the code produced relies on an external dependency from the Kaitai
Struct project, so the result is not standalone.</p>
<p>In comparison, the internal structure of a <code>.DS_Store</code> file is immensely more
complex as the following diagram can attest (also programmatically generated
thanks to the Kaitai Struct project):</p>
<p><a href="./images/ds_store.png"><img src="./images/ds_store.png" alt="Diagram of the internal structure of a .DS_Store file"></a></p>
<p>Basically, a <code>.DS_Store</code> file structures its data as
<a href="https://en.wikipedia.org/wiki/B-tree" title="B-tree">B-trees</a>, with each B-tree referred to as a &ldquo;directory&rdquo; in
this file format&rsquo;s terminology. Each directory consists of blocks (where a block
represents a node in a B-tree), and each block consists of records. Each record
contains a filename and a type that defines the purpose of its value.</p>
<p>It took me some time to write a functional Kaitai Struct format specification
for the <code>.DS_Store</code> files, but the result is now publicly accessible in the
<a href="https://formats.kaitai.io/ds_store/index.html" title="Kaitai Struct - Format Gallery">Kaitai Struct&rsquo;s Format Gallery</a>.</p>

<h2 id="probing-ds_store-files-with-zap">Probing .DS_Store Files with ZAP <a class="header-link" href="#probing-ds_store-files-with-zap"><svg class="fill-current o-60 hover-accent-color-light" height="22px" viewBox="0 0 24 24" width="22px" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z" fill="currentColor"/></svg></a></h2>
<p>ZAP has a tool called the Spider which enables to discover new resources on a
website. Basically, it works by scanning a web page for references to other
resources and then proceeds recursively until exhausting all remaining links.
Additionally, the Spider tries to access some resources which are not referenced
by any web pages, like <code>robots.txt</code> or Git metadata files. To do so, it sends
requests targeting those hidden files in the folders it has already discovered
on the remote web server.</p>
<p>Once the Spider has detected a file named <code>.DS_Store</code> on a remote server and
made sure it starts with the right alignment bytes, it starts the parsing
process (<a href="https://github.com/zaproxy/zap-extensions/blob/5e078b1770c888a1bd6071e2a314d86c3128ddb0/addOns/spider/src/main/java/org/zaproxy/addon/spider/parser/DsStoreParser.java#L111-L115">see on
GitHub</a>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">canParseResource</span>(ParseContext ctx, <span style="color:#66d9ef">boolean</span> wasAlreadyParsed) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ctx.<span style="color:#a6e22e">getPath</span>().<span style="color:#a6e22e">endsWith</span>(<span style="color:#e6db74">&#34;.DS_Store&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&amp;&amp;</span> startsWith(ctx.<span style="color:#a6e22e">getHttpMessage</span>().<span style="color:#a6e22e">getResponseBody</span>().<span style="color:#a6e22e">getBytes</span>(), MAGIC_BYTES);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>A new instance of the <code>DsStore</code> class generated by the Kaitai Struct compiler is
then created, allowing to easily navigate the inner workings of the <code>.DS_Store</code>
file (<a href="https://github.com/zaproxy/zap-extensions/blob/5e078b1770c888a1bd6071e2a314d86c3128ddb0/addOns/spider/src/main/java/org/zaproxy/addon/spider/parser/DsStoreParser.java#L56-L63">see on
GitHub</a>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>DsStore dsStore <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    dsStore <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> DsStore((<span style="color:#66d9ef">new</span> ByteBufferKaitaiStream(message.<span style="color:#a6e22e">getResponseBody</span>().<span style="color:#a6e22e">getBytes</span>())));
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">catch</span> (Exception ex) {
</span></span><span style="display:flex;"><span>    getLogger().<span style="color:#a6e22e">debug</span>(ex.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>For each directory (B-tree) in the <code>.DS_Store</code> file, the master block is read to
obtain the location of the root block. The B-tree is then traversed recursively
from its root block (<a href="https://github.com/zaproxy/zap-extensions/blob/86462afb267aceea74a8d3d65e39809d7c26f2f5/addOns/spider/src/main/java/org/zaproxy/addon/spider/parser/DsStoreParser.java#L64-L78">see on
GitHub</a>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (MasterBlockRef masterBlockRef : dsStore.<span style="color:#a6e22e">buddyAllocatorBody</span>().<span style="color:#a6e22e">directories</span>()) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Each B-tree directory has one master block comprising metadata.</span>
</span></span><span style="display:flex;"><span>    MasterBlock masterBlock <span style="color:#f92672">=</span> masterBlockRef.<span style="color:#a6e22e">masterBlock</span>();
</span></span><span style="display:flex;"><span>    getLogger().<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;Records: {}&#34;</span>, masterBlock.<span style="color:#a6e22e">numRecords</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Block rootBlock <span style="color:#f92672">=</span> masterBlock.<span style="color:#a6e22e">rootBlock</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Traverse recursively the B-tree from its root block.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        traverse(rootBlock, ctx);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        getLogger().<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;There was an issue parsing the .DS_Store. {}&#34;</span>, e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>        getLogger().<span style="color:#a6e22e">debug</span>(e, e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>A block can be either an internal node of the B-tree or a leaf node. Internal
nodes contain references to other nodes unlike leaf ones. The <code>traverse</code> method
explores each node of the tree by calling itself recursively when a reference to
another block is found. Finally, for each block, the filename contained in its
record is extracted and used to build new URLs for the Spider to probe (<a href="https://github.com/zaproxy/zap-extensions/blob/5e078b1770c888a1bd6071e2a314d86c3128ddb0/addOns/spider/src/main/java/org/zaproxy/addon/spider/parser/DsStoreParser.java#L84-L109">see on
GitHub</a>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">traverse</span>(Block block, ParseContext ctx) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>    getLogger().<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;Traversing&#34;</span>);
</span></span><span style="display:flex;"><span>    Block nextBlock <span style="color:#f92672">=</span> block.<span style="color:#a6e22e">rightmostBlock</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (nextBlock <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        traverse(nextBlock, ctx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> alreadyChecked <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (BlockData blockData : block.<span style="color:#a6e22e">data</span>()) {
</span></span><span style="display:flex;"><span>        nextBlock <span style="color:#f92672">=</span> blockData.<span style="color:#a6e22e">block</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (nextBlock <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            getLogger().<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;Recursed&#34;</span>);
</span></span><span style="display:flex;"><span>            traverse(nextBlock, ctx);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        String entry <span style="color:#f92672">=</span> blockData.<span style="color:#a6e22e">record</span>().<span style="color:#a6e22e">filename</span>().<span style="color:#a6e22e">value</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (alreadyChecked.<span style="color:#a6e22e">contains</span>(entry)) {
</span></span><span style="display:flex;"><span>            getLogger().<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;{} already done&#34;</span>, entry);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        alreadyChecked.<span style="color:#a6e22e">add</span>(entry);
</span></span><span style="display:flex;"><span>        getLogger().<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;Processing: {}&#34;</span>, entry);
</span></span><span style="display:flex;"><span>        processUrl(ctx, entry);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
<h2 id="conclusion">Conclusion <a class="header-link" href="#conclusion"><svg class="fill-current o-60 hover-accent-color-light" height="22px" viewBox="0 0 24 24" width="22px" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z" fill="currentColor"/></svg></a></h2>
<p>Probing and parsing <code>.DS_Store</code> files directly in ZAP is one step further into
completing its set of tools for assessing the security of web applications. I am
so delighted for this feature to finally be implemented. It took years from the
moment I started poking around with the Kaitai Struct project, my contribution
to the format gallery regarding the <code>.DS_Store</code> description, the idea of using
it to enhance the ZAP Spider and our collaboration with
<a href="https://github.com/kingthorin" title="kingthorin - GitHub profile">kingthorin</a> on the implementation.</p>

          </main>
          <div class="next-content bg--blue-lightest p-10">
              
                Previous <a class="previous" href="/blog/2023-09-01-zap-updates-august-2023/"> ZAP Updates - August 2023</a>
              
              
                Next <a class="next" href="/blog/2023-09-11-browser-recorder/"> GSoC 2023 Browser Recorder</a>
              
          </div>
      </article>
      <aside class="col-1-3">
        <section class="post-meta">
          
          
          <div class="post-authors">
            
            
              <section class="post-author-single flex p-10">
                <div class="col-1-5">
                  
                  <img class="author-picture" src="/img/authors/skyper_256x256.jpg" />
                  
                </div>
                <div class="author-name col-4-5">
                  
                    Paul-Emmanuel Raoul (a.k.a Skyper)
                  
                  
                </div>
              </section>
          

          <h4>Table of Contents</h4>
          <nav id="TableOfContents">
  <ul>
    <li><a href="#parsing-ds_store-files">Parsing .DS_Store Files</a></li>
    <li><a href="#probing-ds_store-files-with-zap">Probing .DS_Store Files with ZAP</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>

          
          <h4>Tags</h4>
          <ul id="tags">
           
           <li> <a href="/tags/blog/">blog</a> </li>
           
           <li> <a href="/tags/recon/">recon</a> </li>
           
           <li> <a href="/tags/spider/">spider</a> </li>
           
          </ul>
          
          </div>
                    
        </section>
      </aside>
    </div>
</div>

 </div>
  <footer class="site-footer py-20 mt-20">
  <div class="wrapper flex jc-sb">
    <div class="flex ai-c">
    <div class="footer-logo"><svg xmlns="http://www.w3.org/2000/svg" width="55px" viewBox="0 0 77.58 77.61"><path d="M49.48 21.64a3.46 3.46 0 0 1 .44 3 3.38 3.38 0 0 1-2.16 2.14l-1.17.38 10.74 13.56a3.39 3.39 0 0 1-1.83 5.41l-2 .5L68 65A37.78 37.78 0 0 0 39.85 2c-1.34 0-2.66.07-4 .2zM23.33 48.26a3.4 3.4 0 0 1 .45-6.09L25 41.7l-13.81-10a3.4 3.4 0 0 1 .62-5.86l.2-.09-5.47-3.84a37.79 37.79 0 0 0 55.32 48.6z" fill="#fff"/><path d="M67.84 69.48L49 45.59a.55.55 0 0 1 .28-.87l5.55-1.36a.58.58 0 0 0 .23-.13.48.48 0 0 0 .09-.11.62.62 0 0 0 .08-.24.58.58 0 0 0 0-.26.54.54 0 0 0-.07-.13L42.29 26.37a.75.75 0 0 1-.07-.12.55.55 0 0 1 .31-.74l4.35-1.4a.54.54 0 0 0 .26-.83L30.92.22a.5.5 0 0 0-.61-.22L.32 13a.55.55 0 0 0-.1.94l16.72 11.88a.52.52 0 0 1 .22.49.45.45 0 0 1-.09.26.48.48 0 0 1-.09.11l-.13.08-3.93 1.72a.55.55 0 0 0-.29.31v.13a.59.59 0 0 0 .22.5l8.62 6.22 8.61 6.21a.55.55 0 0 1 0 .87.57.57 0 0 1-.13.08l-5.11 2a.55.55 0 0 0-.28.75.56.56 0 0 0 .21.22l42.43 24.5a.53.53 0 0 0 .64-.79z" fill="#fff"/></svg></div>
    <div class="footer-left">
      <nav class="footer-nav">
        <ul class="flex">
        
        
          
            <li class="ml-10"><a href="/blog/" title="Blog page">Blog</a></li>
          
        
          
            <li class="ml-10"><a href="/videos/" title="Videos page">Videos</a></li>
          
        
          
            <li class="ml-10"><a href="/community/" title="Community page">Community</a></li>
          
        
          
            <li class="ml-10"><a href="/docs/statistics/" title="Statistics page">Statistics</a></li>
          
        
        </ul>
      </nav>
      



  <div class="ml-10">
    <a href="https://github.com/zaproxy/zaproxy-website/blob/main/site/content/blog/2023-09-08-ds-store-parsing/index.md">Edit on GitHub</a>
  </div>

    </div>
  </div>

    <div class="flex ai-c">
      <span class="OutroFooter">
      © Copyright 2025 the ZAP Dev Team</br>
      ZAP by <a href="https://checkmarx.com" aria-label="Checkmarx">Checkmarx</a>
      </span>
      <ul class="flex footer-social">
        <li>
          <a href="https://github.com/zaproxy/" aria-label="Go to ZAP's GitHub repo"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.36 18.88"><path d="M9.68 0a9.68 9.68 0 0 0-3.06 18.86c.48.09.64-.21.64-.46v-1.8C4.57 17.18 4 15.45 4 15.45A2.57 2.57 0 0 0 2.93 14c-.88-.6.07-.59.07-.59a2 2 0 0 1 1.48 1 2.06 2.06 0 0 0 2.82.8A2 2 0 0 1 7.91 14c-2.15-.29-4.41-1.12-4.41-4.83a3.72 3.72 0 0 1 1-2.59A3.53 3.53 0 0 1 4.59 4s.82-.26 2.67 1a9 9 0 0 1 4.84 0c1.9-1.25 2.66-1 2.66-1a3.49 3.49 0 0 1 .1 2.57 3.71 3.71 0 0 1 1 2.59c0 3.72-2.26 4.54-4.42 4.78a2.3 2.3 0 0 1 .67 1.79v2.67c0 .25.15.56.64.46A9.68 9.68 0 0 0 9.68 0z" fill="#00549e"/></svg></a>
        </li>
        <li>
            <a href="https://twitter.com/zaproxy" aria-label="Follow ZAP on Twitter"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.36 15.73"><path d="M19.36 1.86a8 8 0 0 1-2.28.63 3.94 3.94 0 0 0 1.74-2.2 7.53 7.53 0 0 1-2.52 1 4 4 0 0 0-6.77 3.59A11.29 11.29 0 0 1 1.35.73 4 4 0 0 0 2.58 6a3.91 3.91 0 0 1-1.8-.5A4 4 0 0 0 4 9.48a4 4 0 0 1-1.79.06 4 4 0 0 0 3.67 2.76A8 8 0 0 1 0 14a11.32 11.32 0 0 0 6.09 1.78A11.24 11.24 0 0 0 17.38 3.92a8.08 8.08 0 0 0 1.98-2.06z" fill="#00549e"/></svg></a>
        </li>
      </ul>
    </div>
  </div>
</footer>

  
  
    <script src="/main.4d3af1.js"></script>
  
</div>
</body>
</html>
